#!/usr/bin/env python3

import re
import subprocess
import sys
import os
from pathlib import Path
import textwrap

def get_clipboard_content():
    """Get content from clipboard"""
    try:
        result = subprocess.run(['pbpaste'], capture_output=True, text=True)
        return result.stdout.strip()
    except Exception as e:
        print(f"Error getting clipboard content: {e}")
        sys.exit(1)

def parse_ssh_command(ssh_cmd):
    """Parse SSH command to extract host and port"""
    # Pattern to match: ssh -p PORT USER@HOST -L ...
    pattern = r'ssh\s+-p\s+(\d+)\s+(\w+)@([\d\.]+)'
    match = re.match(pattern, ssh_cmd)

    if not match:
        print(f"Error: Clipboard content doesn't match expected SSH format")
        print(f"Expected format: ssh -p PORT USER@HOST -L ...")
        print(f"Got: {ssh_cmd}")
        sys.exit(1)

    port, user, host = match.groups()
    return host, port, user

def add_vastai_ssh(host, port, user):
    """Add new vastai remote"""
    with open(Path.home() / '.ssh/config.d/vastai', 'w') as f:
        f.write(textwrap.dedent(f'''\
            Host vastai
              Hostname {host}
              User {user}
              Port {port}
            '''))

def main():
    # Get clipboard content
    clipboard_content = get_clipboard_content()

    # Parse SSH command
    host, port, user = parse_ssh_command(clipboard_content)

    add_vastai_ssh(host, port, user)

if __name__ == "__main__":
    main()
